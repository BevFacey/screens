<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="
    default-src * 'unsafe-inline' 'unsafe-eval';
    script-src * 'unsafe-inline' 'unsafe-eval';
    connect-src *;
    img-src * data:;
    style-src * 'unsafe-inline';
    frame-src *;
">

<title>TV Controller</title>

<script>
// password gate
let pw = prompt("Password?");
if (pw !== "password") {
    document.write("<h1>Access Denied</h1>");
    throw new Error("Denied");
}
</script>

<style>
body { font-family: Arial; }
.clientBox { margin: 6px 0; }
</style>
</head>
<body>

<h1>Client Controller</h1>

<div id="clientList">Loading clients...</div>

<input id="urlInput" type="text" placeholder="Enter URL">
<button onclick="sendToSelected()">Send to selected</button>
<button onclick="sendToAll()">Send to ALL</button>

<h3>Recent URLs</h3>
<pre id="url-log" style="white-space: pre-wrap; font-size: 0.9rem;"></pre>

<script>
let selected = new Set();
let recentUrls = [];

function normalizeURL(raw) {
    let url = raw.trim();

    // Add https:// if missing
    if (!url.startsWith("http://") && !url.startsWith("https://")) {
        url = "https://" + url;
    }

    // ----- YOUTUBE â†’ IFRAME EMBED -----

    // Matches: youtube.com/watch?v=ID
    const watchMatch = url.match(/youtube\.com\/watch\?v=([^&]+)/);
    if (watchMatch) {
        const id = watchMatch[1];
        return "https://www.youtube.com/embed/" + id + "?autoplay=1&mute=1";
    }

    // Matches: youtube.com/shorts/ID
    const shortsMatch = url.match(/youtube\.com\/shorts\/([^?&]+)/);
    if (shortsMatch) {
        const id = shortsMatch[1];
        return "https://www.youtube.com/embed/" + id + "?autoplay=1&mute=1";
    }

    // Matches: youtu.be/ID
    const shortMatch = url.match(/youtu\.be\/([^?&]+)/);
    if (shortMatch) {
        const id = shortMatch[1];
        return "https://www.youtube.com/embed/" + id + "?autoplay=1&mute=1";
    }

    // If it's already an embed link, leave it
    if (url.includes("youtube.com/embed/")) {
        return url;
    }

    // Otherwise return the cleaned URL
    return url;
}


function loadClients() {
    fetch("clients.json?" + Date.now())
    .then(r => r.json())
    .then(list => {
        let html = "";
        for (let id in list) {
            html += `
                <div class="clientBox">
                    <label>
                        <input type="checkbox" onchange="toggle('${id}')"> ${id}
                    </label>
                    <button onclick="disconnect('${id}')">Remove</button>
                </div>
            `;
        }
        document.getElementById("clientList").innerHTML = html;
    });
}
loadClients();
setInterval(loadClients, 3000);

function toggle(id) {
    if (selected.has(id)) selected.delete(id);
    else selected.add(id);
}

function updateCommands(callback) {
    fetch("commands.json")
        .then(r => r.json())
        .then(callback);
}

function writeCommands(cmd) {
    return fetch("write.php?file=commands.json", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(cmd)
    });
}

function sendToSelected() {
    let url = normalizeURL(document.getElementById("urlInput").value);
    recentUrls.push(url);
    updateCommands(cmd => {
        selected.forEach(id => cmd[id] = url);
        writeCommands(cmd);
    });
}

function sendToAll() {
    let url = normalizeURL(document.getElementById("urlInput").value);
    recentUrls.push(url);
    fetch("clients.json")
        .then(r => r.json())
        .then(clients => {
            updateCommands(cmd => {
                for (let id in clients) cmd[id] = url;
                writeCommands(cmd);
            });
        });
}

function disconnect(id) {
    fetch("clients.json")
        .then(r => r.json())
        .then(list => {
            updateCommands(cmd => {
                selected.forEach(id => cmd[id] = "https://google.com");
                writeCommands(cmd);
            });
            delete list[id];
            return fetch("write.php?file=clients.json", {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify(list)
            });
        });
}
</script>

</body>
</html>
